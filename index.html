<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#cc0000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>絕世帳簿 - 港漫 AI 記帳</title>
    
    <link id="manifest-link" rel="manifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+KuaiLe&family=Inter:wght@900&display=swap');
        
        :root { 
            --ink-black: #000000; 
            --blood-red: #cc0000; 
            --gold: #f59e0b; 
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #1a1a1a;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: center;
            min-height: 100dvh; overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .brush-font { font-family: 'Ma Shan Zheng', cursive; }
        .comic-font { font-family: 'ZCOOL KuaiLe', sans-serif; }

        .phone-container {
            width: 100%; max-width: 500px; height: 100dvh;
            background: #fff; border: 6px solid var(--ink-black);
            position: relative; overflow: hidden;
            box-shadow: 0 0 50px rgba(255,0,0,0.3);
            display: flex; flex-direction: column;
        }

        @media (min-width: 640px) {
            .phone-container { max-width: 375px; height: 812px; border-radius: 32px; margin: 20px; }
        }

        .comic-bg {
            position: absolute; inset: 0;
            background: linear-gradient(45deg, #eee 25%, transparent 25%) -50px 0,
                        linear-gradient(-45deg, #eee 25%, transparent 25%) -50px 0,
                        linear-gradient(45deg, transparent 75%, #eee 75%),
                        linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 100px 100px; opacity: 0.1; pointer-events: none;
        }

        .page-wrapper { flex: 1; position: relative; overflow: hidden; }
        .page {
            position: absolute; inset: 0; overflow-y: auto; display: none; padding: 20px;
            padding-bottom: calc(100px + env(safe-area-inset-bottom)); z-index: 10;
        }
        .page.active { display: block; animation: strike 0.2s ease-out; }

        .status-bar { 
            height: calc(44px + env(safe-area-inset-top)); 
            padding: env(safe-area-inset-top) 24px 0 24px;
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 14px; font-weight: 900; background: #000; color: #fff; z-index: 60;
        }

        .nav-bar { 
            height: calc(84px + env(safe-area-inset-bottom));
            background: #000; display: flex; justify-content: space-around;
            align-items: center; border-top: 4px solid var(--blood-red);
            padding-bottom: env(safe-area-inset-bottom); z-index: 60;
        }

        .ai-btn { 
            width: 70px; height: 70px; background: var(--blood-red); border: 4px solid #fff;
            transform: rotate(-5deg); display: flex; align-items: center; 
            justify-content: center; color: white; margin-top: -65px; 
            box-shadow: 5px 5px 0px #000; cursor: pointer; z-index: 70;
        }

        .nav-item { cursor: pointer; display: flex; flex-direction: column; align-items: center; color: #666; font-weight: 900; flex: 1; }
        .nav-item.active { color: #fff; }

        .manhua-card { border: 4px solid var(--ink-black); background: #fff; position: relative; padding: 15px; margin-bottom: 20px; box-shadow: 6px 6px 0px var(--ink-black); }
        .kungfu-banner { background: var(--ink-black); color: var(--gold); padding: 20px; clip-path: polygon(0 0, 100% 5%, 100% 100%, 0 95%); margin-bottom: 25px; }
        
        .transaction-card { transition: all 0.2s; cursor: pointer; }
        .delete-btn { color: #999; padding: 10px; }

        .on-omatopoeia { position: absolute; font-size: 40px; font-weight: 900; color: var(--blood-red); text-shadow: 3px 3px 0 #000; pointer-events: none; z-index: 100; transform: rotate(-15deg); display: none; }
        .spinner { animation: spin 0.5s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #toast { position: fixed; top: calc(60px + env(safe-area-inset-top)); left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 10px 20px; border: 2px solid var(--blood-red); font-weight: 900; z-index: 1000; display: none; text-align: center; width: 80%; }
        
        /* 圖片預覽樣式 */
        #img-preview-container { display: none; margin-bottom: 10px; border: 2px dashed #000; padding: 5px; position: relative; }
        #img-preview { max-height: 100px; width: auto; border: 2px solid #000; }
        .clear-img { position: absolute; top: -10px; right: -10px; background: #000; color: #fff; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #fff; }
    </style>
</head>
<body>

    <div id="toast" class="brush-font text-sm">系統提示</div>

    <div id="init-overlay" class="hidden fixed inset-0 bg-[#1a1a1a] z-[999] flex items-center justify-center p-5">
        <div class="manhua-card w-full max-w-sm">
            <h2 class="brush-font text-3xl mb-4 text-center">開山立派</h2>
            <p class="text-xs font-bold text-slate-500 mb-6 text-center italic">「英雄，請輸入你的雲端心法 (Firebase Config)」</p>
            <textarea id="fb-config-input" rows="8" placeholder='貼上 Firebase Console 提供的 SDK 設定...' class="w-full border-4 border-black p-3 text-[10px] font-mono mb-4 outline-none focus:bg-yellow-50"></textarea>
            <button id="save-fb-btn" class="w-full bg-red-600 text-white font-black py-3 border-b-4 border-r-4 border-black uppercase tracking-widest">注入神功</button>
        </div>
    </div>

    <div class="phone-container" id="app-container">
        <div class="comic-bg"></div>
        <div id="fx-text" class="on-omatopoeia brush-font">轟！</div>

        <div class="status-bar">
            <span id="clock" class="comic-font">辰時</span>
            <div class="flex gap-2"><i class="fas fa-dragon"></i><i class="fas fa-bolt"></i></div>
        </div>

        <div class="page-wrapper">
            <!-- 主城 -->
            <div id="page-home" class="page active">
                <div class="py-4">
                    <div class="flex justify-between items-center mb-6">
                        <div class="overflow-hidden">
                            <p class="text-[10px] font-black uppercase text-slate-400">UID #<span id="user-id-suffix">...</span></p>
                            <h2 class="text-3xl font-black brush-font truncate" id="user-display">強者之路</h2>
                        </div>
                        <div class="w-14 h-14 border-4 border-black bg-yellow-400 flex items-center justify-center shadow-[4px_4px_0px_#000]">
                            <i class="fas fa-user-ninja text-2xl"></i>
                        </div>
                    </div>
                    
                    <div class="kungfu-banner" id="combat-power-banner">
                        <p class="text-[10px] font-black italic tracking-widest opacity-80 mb-1 flex items-center gap-2">
                            <span id="power-label-display">戰鬥力 (功力)</span>
                            <i class="fas fa-pen text-[8px] text-gold"></i>
                        </p>
                        <h3 class="text-4xl font-black brush-font truncate" id="total-balance">$0</h3>
                        <div class="grid grid-cols-2 gap-2 mt-4">
                            <div class="border-l-2 border-gold pl-2">
                                <p class="text-[8px] font-black text-white/60">吸星 (入)</p>
                                <p class="text-sm font-black text-white truncate" id="monthly-income">+$0</p>
                            </div>
                            <div class="border-l-2 border-red-500 pl-2">
                                <p class="text-[8px] font-black text-white/60">散功 (出)</p>
                                <p class="text-sm font-black text-white truncate" id="monthly-expense">-$0</p>
                            </div>
                        </div>
                    </div>

                    <h4 class="text-xl font-black mb-4 brush-font border-b-4 border-black inline-block">錢財決鬥史</h4>
                    <div class="space-y-4" id="transaction-list"></div>
                </div>
            </div>

            <!-- 戰報 -->
            <div id="page-stats" class="page">
                <div class="py-4">
                    <h2 class="text-3xl font-black mb-6 brush-font">江湖戰報</h2>
                    <div class="space-y-4" id="stats-container"></div>
                </div>
            </div>

            <!-- 天機算 (AI 聊天 + OCR) -->
            <div id="page-ai" class="page" style="padding: 0; background: #fff;">
                <div class="flex flex-col h-full">
                    <div class="bg-black p-4 flex items-center gap-4 border-b-4 border-red-600">
                        <div class="w-10 h-10 bg-red-600 border-2 border-white flex items-center justify-center text-white text-xl">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="overflow-hidden">
                            <h3 class="text-white brush-font text-lg">天機算大師</h3>
                            <p class="text-[9px] text-gold font-black uppercase tracking-widest">AI Vision OCR</p>
                        </div>
                    </div>
                    
                    <div id="chat-messages" class="flex-1 p-4 space-y-6 overflow-y-auto"></div>
                    
                    <div class="p-3 bg-white border-t-4 border-black">
                        <!-- 圖片預覽區 -->
                        <div id="img-preview-container">
                            <div class="clear-img" onclick="clearImage()"><i class="fas fa-times"></i></div>
                            <img id="img-preview" src="" alt="收據預覽">
                            <p class="text-[9px] font-black text-red-600 mt-1 uppercase italic">大師已開法眼分析此貼...</p>
                        </div>

                        <form id="chat-form" class="flex gap-2 items-end">
                            <!-- 隱藏的 File Input -->
                            <input type="file" id="camera-input" accept="image/*" class="hidden" onchange="previewImage(this)">
                            <button type="button" onclick="document.getElementById('camera-input').click()" class="w-12 h-12 bg-yellow-400 border-4 border-black flex items-center justify-center text-xl shadow-[2px_2px_0px_#000] active:shadow-none active:translate-x-1 active:translate-y-1">
                                <i class="fas fa-camera"></i>
                            </button>
                            
                            <input type="text" id="chat-input" placeholder="直接講話或拍收據..." class="flex-1 border-4 border-black px-3 py-3 font-black text-xs outline-none focus:bg-yellow-50">
                            
                            <button type="submit" id="send-btn" class="w-12 h-12 bg-black text-white border-b-4 border-r-4 border-red-600 active:border-0 flex items-center justify-center">
                                <i class="fas fa-fist-raised text-lg" id="btn-icon"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 設定 -->
            <div id="page-settings" class="page">
                <div class="py-4">
                    <h2 class="text-3xl font-black mb-6 brush-font">門派設定</h2>
                    <div class="manhua-card bg-slate-50">
                        <h5 class="text-xs font-black uppercase mb-2 text-red-600 italic">英雄稱號</h5>
                        <input type="text" id="username-input" class="w-full border-2 border-black p-2 text-xs font-bold mb-2">
                        <button id="save-username-btn" class="w-full bg-black text-white py-2 text-xs font-black border-b-4 border-r-4 border-red-600">修煉名號</button>
                    </div>
                    <div class="manhua-card bg-slate-50 mt-4">
                        <h5 class="text-xs font-black uppercase mb-2 text-red-600 italic">初始功力</h5>
                        <input type="number" id="base-balance-input" class="w-full border-2 border-black p-2 text-xs font-bold mb-2">
                        <button id="save-base-btn" class="w-full bg-black text-white py-2 text-xs font-black border-b-4 border-r-4 border-gold">注入本錢</button>
                    </div>
                    <div class="manhua-card bg-slate-50 mt-4">
                        <h5 class="text-xs font-black uppercase mb-2 text-red-600 italic">內功心法 (Gemini API Key)</h5>
                        <input type="password" id="api-key-input" class="w-full border-2 border-black p-2 text-xs font-bold mb-2">
                        <button id="save-key-btn" class="w-full bg-black text-white py-2 text-xs font-black border-b-4 border-r-4 border-red-600">修煉心法</button>
                    </div>
                    <div class="manhua-card mt-6 bg-red-50 border-dashed border-2 text-center">
                        <button id="reset-system-btn" class="text-[10px] font-black text-red-600 uppercase py-2">重置所有設定</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="nav-bar">
            <div class="nav-item active" data-page="home"><i class="fas fa-fort-awesome"></i><span class="text-[9px]">主城</span></div>
            <div class="nav-item" data-page="stats"><i class="fas fa-scroll"></i><span class="text-[9px]">戰報</span></div>
            <div class="ai-btn" id="ai-trigger"><i class="fas fa-eye text-2xl"></i></div>
            <div class="nav-item" data-page="settings"><i class="fas fa-map-marked-alt"></i><span class="text-[9px]">江湖</span></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const STORAGE_KEY_FB = 'FB_CONFIG_JSON_V3';
        const STORAGE_KEY_GEMINI = 'GEMINI_API_KEY_V3';
        const STORAGE_KEY_APPID = 'APP_ID_V3';
        const STORAGE_KEY_BASE = 'BASE_BALANCE_V3';
        const STORAGE_KEY_NAME = 'USER_NAME_V3';
        const STORAGE_KEY_LABEL = 'POWER_LABEL_V3';
        const DEFAULT_APP_ID = 'fin-track-manhua';

        const ICONS = { '餐飲': 'drumstick-bite', '交通': 'horse', '娛樂': 'theater-masks', '收入': 'dragon', '購物': 'gem', '其他': 'bolt' };
        const CATEGORIES = ['餐飲', '交通', '娛樂', '收入', '購物', '其他'];

        let db, auth;
        let currentAppId = localStorage.getItem(STORAGE_KEY_APPID) || DEFAULT_APP_ID;
        let baseBalance = parseFloat(localStorage.getItem(STORAGE_KEY_BASE)) || 0;
        let userName = localStorage.getItem(STORAGE_KEY_NAME) || '強者之路';
        let powerLabel = localStorage.getItem(STORAGE_KEY_LABEL) || '戰鬥力 (功力)';
        let currentBase64 = null;

        const toast = document.getElementById('toast');
        const showToast = (msg) => { toast.innerText = msg; toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 3000); };

        const startApp = (config) => {
            try {
                const firebaseApp = initializeApp(config);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                onAuthStateChanged(auth, (user) => { if (user) startDataSync(user.uid); else signInAnonymously(auth); });
                document.getElementById('init-overlay').classList.add('hidden');
            } catch (err) { localStorage.removeItem(STORAGE_KEY_FB); location.reload(); }
        };

        const savedConfig = localStorage.getItem(STORAGE_KEY_FB);
        if (savedConfig) startApp(JSON.parse(savedConfig));
        else if (typeof __firebase_config !== 'undefined') startApp(JSON.parse(__firebase_config));
        else document.getElementById('init-overlay').classList.remove('hidden');

        // --- 核心同步 ---
        function startDataSync(userId) {
            const transRef = collection(db, 'artifacts', currentAppId, 'users', userId, 'transactions');
            onSnapshot(transRef, (snap) => {
                const data = []; snap.forEach(d => data.push({ id: d.id, ...d.data() }));
                data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                updateUI(data, userId);
                updateStats(data);
            });
        }

        // --- 圖片預覽與清理 ---
        window.previewImage = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                currentBase64 = e.target.result.split(',')[1];
                document.getElementById('img-preview').src = e.target.result;
                document.getElementById('img-preview-container').style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.clearImage = () => {
            currentBase64 = null;
            document.getElementById('camera-input').value = '';
            document.getElementById('img-preview-container').style.display = 'none';
        };

        // --- AI OCR 核心 ---
        async function callGemini(prompt, base64) {
            const key = localStorage.getItem(STORAGE_KEY_GEMINI);
            if (!key) throw new Error("MISSING_KEY");

            const sys = `你是一位港漫風格大師。如果是文字輸入，請按類別歸類。如果是收據圖片，請識別收據上的：商戶名稱(title)、總金額(amount)、消費分類(category)，並回傳一段霸氣吐槽(comment)。
            分類限：餐飲、交通、娛樂、收入、購物、其他。
            如果是支出，amount 必須是負數；如果是收入，amount 是正數。回傳純 JSON 格式：{"title": string, "amount": number, "category": string, "comment": string}`;

            const contents = [{
                role: "user",
                parts: [{ text: prompt || "請分析這張收據。" }]
            }];

            if (base64) {
                contents[0].parts.push({
                    inlineData: { mimeType: "image/png", data: base64 }
                });
            }

            const payload = { 
                contents, 
                systemInstruction: { parts: [{ text: sys }] },
                generationConfig: { responseMimeType: "application/json" }
            };

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, { 
                method: 'POST', 
                body: JSON.stringify(payload) 
            });
            const json = await res.json();
            return JSON.parse(json.candidates[0].content.parts[0].text);
        }

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const val = input.value.trim();
            if (!val && !currentBase64) return;

            const msgBox = document.getElementById('chat-messages');
            const displayVal = currentBase64 ? "【法眼識別中...】 " + val : val;
            msgBox.innerHTML += `<div class="flex justify-end"><div class="manhua-card bg-black text-white border-white text-xs font-black">${displayVal}</div></div>`;
            
            const tempBase64 = currentBase64;
            input.value = '';
            clearImage();
            document.getElementById('btn-icon').className = "fas fa-sync-alt spinner";

            try {
                const p = await callGemini(val, tempBase64);
                await addDoc(collection(db, 'artifacts', currentAppId, 'users', auth.currentUser.uid, 'transactions'), { ...p, timestamp: serverTimestamp() });
                triggerFX(p.amount < 0 ? '散！' : '吸！');
                msgBox.innerHTML += `<div class="flex justify-start animate-fadeIn"><div class="manhua-card !mb-0 text-xs font-black border-red-600 border-l-[10px]">【大師】：識別到「${p.title}」花費 $${Math.abs(p.amount)}。<br><span class="italic text-[10px] opacity-70">${p.comment}</span></div></div>`;
            } catch (e) {
                msgBox.innerHTML += `<div class="text-red-600 text-[10px] text-center font-bold">大師走火入魔！請檢查內功 (API Key)</div>`;
            } finally {
                document.getElementById('btn-icon').className = "fas fa-fist-raised";
                msgBox.scrollTo(0, msgBox.scrollHeight);
            }
        };

        // --- UI & Stats ---
        function updateUI(transactions, userId) {
            const list = document.getElementById('transaction-list');
            let inc = 0, exp = 0;
            list.innerHTML = transactions.length ? '' : '<div class="text-center py-10 opacity-30 brush-font text-lg">英雄尚未留下足跡</div>';
            transactions.forEach(t => {
                const amt = parseFloat(t.amount);
                if (amt > 0) inc += amt; else exp += Math.abs(amt);
                const card = document.createElement('div');
                card.className = "manhua-card transaction-card flex items-center gap-4 py-3 animate-fadeIn";
                card.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 bg-black text-white flex items-center justify-center border-2 border-red-600 shadow-[2px_2px_0px_#cc0000]">
                        <i class="fas fa-${ICONS[t.category] || 'bolt'}"></i>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p class="font-black text-sm uppercase truncate">${t.title}</p>
                        <p class="text-[8px] font-bold text-red-600 uppercase">#${t.category}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black brush-font text-sm ${amt > 0 ? 'text-green-600' : 'text-red-600'}">
                            ${amt > 0 ? '+' : ''}${amt.toLocaleString()}
                        </span>
                        <div class="delete-btn cursor-pointer" onclick="event.stopPropagation(); window.delT('${t.id}','${userId}')"><i class="fas fa-burst"></i></div>
                    </div>
                `;
                list.appendChild(card);
            });
            document.getElementById('total-balance').innerText = `$${(baseBalance + inc - exp).toLocaleString()}`;
            document.getElementById('monthly-income').innerText = `+$${inc.toLocaleString()}`;
            document.getElementById('monthly-expense').innerText = `-$${exp.toLocaleString()}`;
            document.getElementById('user-display').innerText = userName;
            document.getElementById('power-label-display').innerText = powerLabel;
        }

        window.delT = async (id, userId) => {
            if (confirm("廢除此紀錄？")) {
                await deleteDoc(doc(db, 'artifacts', currentAppId, 'users', userId, 'transactions', id));
                triggerFX("碎！");
            }
        };

        function updateStats(transactions) {
            const periods = {
                day: t => new Date(t*1000).toDateString() === new Date().toDateString(),
                week: t => (Date.now() - t*1000) < 7*24*60*60*1000,
                month: t => new Date(t*1000).getMonth() === new Date().getMonth() && new Date(t*1000).getFullYear() === new Date().getFullYear(),
                year: t => new Date(t*1000).getFullYear() === new Date().getFullYear()
            };
            const labels = { day: '今日決鬥', week: '本週戰果', month: '本月功力', year: '年度總結' };
            const container = document.getElementById('stats-container');
            container.innerHTML = '';
            
            Object.keys(periods).forEach(p => {
                let pIn = 0, pOut = 0;
                transactions.filter(t => t.timestamp && periods[p](t.timestamp.seconds)).forEach(t => {
                    const a = parseFloat(t.amount); if (a > 0) pIn += a; else pOut += Math.abs(a);
                });
                const total = pIn - pOut;
                const ratio = (pIn + pOut === 0) ? 0 : (pOut / (pIn + pOut)) * 100;
                container.innerHTML += `
                    <div class="manhua-card border-l-[12px] ${p==='day'?'border-red-600':p==='week'?'border-black':p==='month'?'border-gold':'border-slate-400'}">
                        <h5 class="text-xs font-black uppercase mb-1">${labels[p]}</h5>
                        <div class="flex justify-between items-end">
                            <div class="text-2xl font-black brush-font ${total>=0?'text-green-600':'text-red-600'}">${total>=0?'':'-'}$${Math.abs(total).toLocaleString()}</div>
                            <div class="text-[9px] font-bold text-slate-400">入:${pIn.toLocaleString()} | 出:${pOut.toLocaleString()}</div>
                        </div>
                        <div class="stat-bar-container"><div class="stat-bar-fill bg-red-600" style="width: ${ratio}%"></div></div>
                    </div>
                `;
            });
        }

        // --- UI Utils ---
        function triggerFX(t) { const f = document.getElementById('fx-text'); f.innerText = t; f.style.display = 'block'; f.style.left = '40%'; f.style.top = '40%'; setTimeout(() => f.style.display = 'none', 800); }
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            const nav = document.querySelector(`.nav-item[data-page="${id}"]`); if (nav) nav.classList.add('active');
        }
        document.querySelectorAll('.nav-item').forEach(n => n.onclick = () => showPage(n.dataset.page));
        document.getElementById('ai-trigger').onclick = () => showPage('ai');
        document.getElementById('save-username-btn').onclick = () => { localStorage.setItem(STORAGE_KEY_NAME, document.getElementById('username-input').value); location.reload(); };
        document.getElementById('save-base-btn').onclick = () => { localStorage.setItem(STORAGE_KEY_BASE, document.getElementById('base-balance-input').value); location.reload(); };
        document.getElementById('save-key-btn').onclick = () => { localStorage.setItem(STORAGE_KEY_GEMINI, document.getElementById('api-key-input').value); showToast("修煉完成！"); };
        document.getElementById('reset-system-btn').onclick = () => { if(confirm("重置所有？")) { localStorage.clear(); location.reload(); } };
        setInterval(() => { const h = new Date().getHours(); document.getElementById('clock').innerText = ["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"][Math.floor(h/2)] + "時"; }, 1000);
    </script>
</body>
</html>
